# 要件定義書

## はじめに

このプロジェクトは、Factory.ai の Droid AI コーディングエージェントを Agent Client Protocol (ACP) に対応させ、Zed エディタおよび他の ACP 準拠エディタから利用可能にするアダプターを開発することを目的としています。既存の Droid CLI の機能をエディタ環境でシームレスに活用できるようにし、開発者の生産性向上を図ります。

## プロダクトビジョン

Factory.ai の Droid をあらゆる ACP 対応エディタから利用可能にし、開発者の生産性を最大化する高性能なオープンソースアダプターを提供します。

## 実装言語選択

このプロジェクトでは、Rust と TypeScript の両方での実装を検討します：

- **Rust実装**: 高性能、メモリ安全性、Zed との親和性を重視
- **TypeScript実装**: 開発速度、エコシステム、メンテナンス性を重視

## 品質目標

- **起動時間**: < 100ms（Rust）、< 500ms（TypeScript）
- **メモリ使用量**: < 20MB/セッション
- **レスポンス時間**: < 50ms（95パーセンタイル）
- **テストカバレッジ**: > 80%

## 要件

### 要件 1: ACP プロトコル実装

**ユーザーストーリー:** 開発者として、Zed エディタから Droid AI エージェントを利用したいので、ACP プロトコルに準拠したアダプターが必要です。

#### 受け入れ基準

1. WHEN エディタが初期化リクエストを送信 THEN アダプターは ACP 0.1.0 プロトコルバージョンで応答 SHALL する
2. WHEN エディタが認証リクエストを送信 THEN アダプターは Factory.ai API キーまたはブラウザ認証で認証処理 SHALL する
3. WHEN エディタがセッション作成リクエストを送信 THEN アダプターは一意のセッション ID を持つセッションを作成 SHALL する
4. WHEN エディタがプロンプトを送信 THEN アダプターは Droid CLI にコマンドを変換して送信 SHALL する

### 要件 2: Droid CLI プロセス管理

**ユーザーストーリー:** 開発者として、アダプターが Droid CLI を安定して管理してほしいので、プロセスの起動・停止・通信が確実に行われる必要があります。

#### 受け入れ基準

1. WHEN アダプターが起動 THEN Droid CLI プロセスを子プロセスとして起動 SHALL する
2. WHEN Droid CLI プロセスが異常終了 THEN アダプターは自動的にプロセスを再起動 SHALL する
3. WHEN アダプターがコマンドを送信 THEN 標準入力経由で Droid CLI にコマンドを送信 SHALL する
4. WHEN Droid CLI が出力を生成 THEN アダプターは標準出力から出力を受信してパース SHALL する

### 要件 3: リアルタイムストリーミング

**ユーザーストーリー:** 開発者として、Droid の思考過程やコード生成をリアルタイムで確認したいので、出力のストリーミング表示が必要です。

#### 受け入れ基準

1. WHEN Droid CLI が出力を生成 THEN アダプターは即座にエディタにチャンクを送信 SHALL する
2. WHEN Droid が計画段階にある THEN アダプターは "thinking" 状態をエディタに通知 SHALL する
3. WHEN Droid がコードを生成 THEN アダプターはコードブロックを識別してハイライト情報と共に送信 SHALL する
4. WHEN Droid がツールを実行 THEN アダプターはツール実行状態をエディタに通知 SHALL する

### 要件 4: ファイル操作機能

**ユーザーストーリー:** 開発者として、Droid にファイルの読み書きを依頼したいので、安全で確実なファイル操作機能が必要です。

#### 受け入れ基準

1. WHEN Droid がファイル読み取りを要求 THEN アダプターは指定されたファイルの内容を取得して Droid に提供 SHALL する
2. WHEN Droid がファイル書き込みを要求 THEN アダプターは変更内容の差分を生成してエディタに表示 SHALL する
3. WHEN ファイル書き込みが実行される THEN アダプターは実際のファイルシステムに変更を適用 SHALL する
4. WHEN ファイル操作が完了 THEN アダプターはエディタに操作完了を通知 SHALL する

### 要件 5: 権限管理システム

**ユーザーストーリー:** 開発者として、危険な操作については事前に確認したいので、リスクレベルに応じた権限管理機能が必要です。

#### 受け入れ基準

1. WHEN Droid が操作を実行しようとする THEN アダプターは操作のリスクレベルを評価 SHALL する
2. IF 操作が中リスク以上 THEN アダプターはエディタに権限確認ダイアログを表示 SHALL する
3. WHEN ユーザーが操作を拒否 THEN アダプターは Droid に操作キャンセルを指示 SHALL する
4. WHEN 自動承認レベルが設定されている AND 操作リスクがそれ以下 THEN アダプターは自動的に操作を承認 SHALL する

### 要件 6: セッション管理

**ユーザーストーリー:** 開発者として、複数のプロジェクトで Droid を使い分けたいので、セッション単位でのコンテキスト管理が必要です。

#### 受け入れ基準

1. WHEN 新しいセッションが作成される THEN アダプターは作業ディレクトリとオープンファイル情報を保存 SHALL する
2. WHEN セッション内でプロンプトが送信される THEN アダプターはセッションコンテキストを Droid に提供 SHALL する
3. WHEN セッションが終了する THEN アダプターは関連するリソースをクリーンアップ SHALL する
4. WHEN 複数セッションが同時に存在する THEN アダプターは各セッションを独立して管理 SHALL する

### 要件 7: エラーハンドリング

**ユーザーストーリー:** 開発者として、エラーが発生した際に適切な情報を得たいので、包括的なエラーハンドリング機能が必要です。

#### 受け入れ基準

1. WHEN Droid CLI が見つからない THEN アダプターは明確なエラーメッセージとインストール手順を提供 SHALL する
2. WHEN Factory.ai 認証が失敗 THEN アダプターは認証 URL と手順を提供 SHALL する
3. WHEN ネットワークエラーが発生 THEN アダプターは再試行機能を提供 SHALL する
4. WHEN 予期しないエラーが発生 THEN アダプターはエラー詳細をログに記録してユーザーに通知 SHALL する

### 要件 8: MCP サーバー統合

**ユーザーストーリー:** 開発者として、Droid が MCP サーバーの機能を活用できるようにしたいので、MCP プロトコルとの統合機能が必要です。

#### 受け入れ基準

1. WHEN エディタが MCP サーバー情報を提供 THEN アダプターは指定された MCP サーバーに接続 SHALL する
2. WHEN Droid が MCP ツールの使用を要求 THEN アダプターは適切な MCP サーバーにツール実行を依頼 SHALL する
3. WHEN MCP サーバーからレスポンスを受信 THEN アダプターは結果を Droid に提供 SHALL する
4. WHEN MCP サーバーとの通信でエラーが発生 THEN アダプターは適切なエラーハンドリングを実行 SHALL する

### 要件 9: 設定とカスタマイズ

**ユーザーストーリー:** 開発者として、自分の環境に合わせてアダプターを設定したいので、柔軟な設定オプションが必要です。

#### 受け入れ基準

1. WHEN アダプターが起動 THEN 環境変数から設定を読み込み SHALL する
2. WHEN Droid CLI のパスが指定されている THEN アダプターは指定されたパスを使用 SHALL する
3. WHEN 自動承認レベルが設定されている THEN アダプターは設定に従って権限管理を実行 SHALL する
4. WHEN デバッグモードが有効 THEN アダプターは詳細なログを出力 SHALL する

### 要件 10: パフォーマンス

**ユーザーストーリー:** 開発者として、快適な開発体験を得たいので、アダプターは高いパフォーマンスを維持する必要があります。

#### 受け入れ基準

1. WHEN ローカルファイル操作を実行 THEN レスポンス時間は 100ms 以下 SHALL である
2. WHEN ストリーミング出力を処理 THEN 遅延は 50ms 以下 SHALL である
3. WHEN 大きなファイルを処理 THEN メモリ使用量は適切に管理される SHALL である
4. WHEN 長時間実行される THEN アダプターはメモリリークを起こさない SHALL である

### 要件 11: プロジェクト構造とビルドシステム

**ユーザーストーリー:** 開発者として、プロジェクトを簡単にビルド・実行できるようにしたいので、適切なプロジェクト構造とビルドシステムが必要です。

#### 受け入れ基準

1. WHEN Rust プロジェクトをビルド THEN `cargo build --release` が成功 SHALL する
2. WHEN TypeScript プロジェクトをビルド THEN `npm run build` が成功 SHALL する
3. WHEN テストを実行 THEN `cargo test` または `npm test` が実行可能 SHALL である
4. WHEN CI/CD パイプラインを実行 THEN 自動テストとリンターが動作 SHALL する

### 要件 12: ターミナル実行とGit操作

**ユーザーストーリー:** 開発者として、Droid にターミナルコマンドや Git 操作を実行してもらいたいので、これらの機能をサポートする必要があります。

#### 受け入れ基準

1. WHEN Droid がターミナルコマンドを実行 THEN アダプターはコマンドを実行して出力を返す SHALL する
2. WHEN Git 操作が要求される THEN アダプターは git commit、push などの操作を実行 SHALL する
3. WHEN インタラクティブな入力が必要 THEN アダプターは適切にユーザー入力を処理 SHALL する
4. WHEN コマンド実行でエラーが発生 THEN アダプターは適切なエラー情報を提供 SHALL する

### 要件 13: 配布とインストール

**ユーザーストーリー:** 利用者として、アダプターを簡単にインストールして使い始めたいので、複数のインストール方法をサポートする必要があります。

#### 受け入れ基準

1. WHEN npm 経由でインストール THEN `npm install -g @community/droid-acp-adapter` でインストール可能 SHALL である
2. WHEN Cargo 経由でインストール THEN `cargo install droid-acp-adapter` でインストール可能 SHALL である
3. WHEN バイナリをダウンロード THEN GitHub Releases から各 OS 用バイナリをダウンロード可能 SHALL である
4. WHEN Homebrew 経由でインストール THEN `brew install droid-acp-adapter` でインストール可能 SHALL である

### 要件 14: ドキュメントとサポート

**ユーザーストーリー:** 新規利用者として、アダプターの使い方を素早く理解したいので、充実したドキュメントが必要です。

#### 受け入れ基準

1. WHEN クイックスタートガイドを参照 THEN 5分以内に動作確認が完了 SHALL する
2. WHEN API リファレンスを参照 THEN 全メソッドの詳細な説明が利用可能 SHALL である
3. WHEN トラブルシューティングを参照 THEN 一般的な問題の解決方法が記載されている SHALL である
4. WHEN 設定例を参照 THEN 各エディタでの設定方法が説明されている SHALL である