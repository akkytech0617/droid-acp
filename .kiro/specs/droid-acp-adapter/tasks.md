# 実装計画

このドキュメントでは、Droid ACP アダプターの実装を段階的に進めるためのタスクリストを定義します。各タスクはユーザー価値を早期に提供できるよう優先順位付けされ、動作する最小限の機能から始めて徐々に改善していくアプローチを採用します。

## スプリント 1: 最小動作版（Hello World）

### 1. 基本的な ACP 通信の確立

- [ ] 1.1 最小限の TypeScript プロジェクトセットアップ
  - package.json の作成（最小限の依存関係のみ）
  - `@zed-industries/agent-client-protocol` パッケージのインストール
  - 単一ファイル（index.ts）でのエントリーポイント作成
  - _要件: 11.2_

- [ ] 1.2 Hello World ACP レスポンス
  - stdin/stdout 通信の基本実装
  - initialize メソッドの最小実装（固定レスポンス）
  - Zed エディタからの接続確認
  - _要件: 1.1_

- [ ] 1.3 基本的なプロンプト受信
  - session/prompt メソッドの最小実装
  - 受信したメッセージをそのまま返すエコー機能
  - JSON-RPC エラーハンドリングの基本実装
  - _要件: 1.4_

## スプリント 2: Droid CLI 統合（MVP）

### 2. Droid CLI との基本通信

- [ ] 2.1 Droid プロセス起動の最小実装
  - child_process を使用した Droid CLI 起動
  - プロセス起動確認（エラー時は固定メッセージ返却）
  - 基本的なプロセス終了処理
  - _要件: 2.1_

- [ ] 2.2 基本的なコマンド送信
  - 受信したプロンプトを Droid CLI にそのまま送信
  - Droid の出力を受信してエディタに返送（バッファリングなし）
  - 基本的なエラー処理（プロセス異常終了時）
  - _要件: 2.3, 2.4_

- [ ] 2.3 最小限の設定システム
  - 環境変数 DROID_EXECUTABLE の読み込み
  - 基本的なログ出力（console.log レベル）
  - 設定エラー時の適切なエラーメッセージ
  - _要件: 9.1, 9.2_

## スプリント 3: リアルタイムストリーミング

### 3. 出力のリアルタイム表示

- [ ] 3.1 基本的なストリーミング実装
  - Droid 出力の行単位でのリアルタイム送信
  - session/update 通知の実装
  - バッファオーバーフロー対策
  - _要件: 3.1_

- [ ] 3.2 簡単な出力解析
  - コードブロック（```）の検出
  - "Planning:" や "Executing:" の検出
  - 状態変更通知の基本実装
  - _要件: 3.2, 3.3, 3.4_

- [ ] 3.3 セッション管理の基本実装
  - セッション ID の生成と管理
  - 作業ディレクトリの設定
  - セッション終了時のクリーンアップ
  - _要件: 6.1, 6.2_

## スプリント 4: ファイル操作機能

### 4. 基本的なファイル読み書き

- [ ] 4.1 ファイル読み取り機能
  - fs/read_text_file メソッドの実装
  - 基本的なパス検証（相対パスのみ許可）
  - ファイル不存在時のエラー処理
  - _要件: 4.1_

- [ ] 4.2 ファイル書き込み機能
  - fs/write_text_file メソッドの実装
  - 既存ファイルの上書き確認なし（後で改善）
  - 書き込み完了通知
  - _要件: 4.3_

- [ ] 4.3 基本的な権限確認
  - 危険な操作（ファイル削除、システムファイル変更）の検出
  - 簡単な確認ダイアログ（Yes/No のみ）
  - 権限拒否時の操作キャンセル
  - _要件: 5.1, 5.2, 5.3_

## スプリント 5: エラーハンドリングと安定性

### 5. ロバストネスの向上

- [ ] 5.1 Droid CLI エラー処理の改善
  - Droid CLI 未発見時の適切なエラーメッセージ
  - インストール手順の提供
  - プロセス異常終了時の自動再起動
  - _要件: 7.1, 2.2_

- [ ] 5.2 認証機能の実装
  - FACTORY_API_KEY 環境変数の確認
  - 認証失敗時のブラウザ認証案内
  - 基本的なトークン検証
  - _要件: 1.2, 7.2_

- [ ] 5.3 基本的なテストの追加
  - 主要機能の単体テスト
  - モック実装（Droid CLI プロセス）
  - CI/CD パイプラインの基本設定
  - _要件: 品質目標_

## スプリント 6: ユーザビリティ向上

### 6. 使いやすさの改善

- [ ] 6.1 設定システムの拡張
  - 設定ファイル（.droidrc）のサポート
  - デバッグモードの実装
  - ログレベル制御
  - _要件: 9.3, 9.4_

- [ ] 6.2 権限管理の改善
  - 自動承認レベルの設定
  - 権限キャッシュ機能
  - "今後も許可" オプション
  - _要件: 5.4_

- [ ] 6.3 差分表示機能
  - ファイル変更前後の差分生成
  - 基本的なハイライト情報
  - 変更サマリーの表示
  - _要件: 4.2_

## スプリント 7: 配布準備

### 7. MVP リリース準備

- [ ] 7.1 CLI インターフェースの実装
  - コマンドライン引数解析
  - ヘルプメッセージ
  - バージョン情報表示
  - _要件: 13.1_

- [ ] 7.2 npm パッケージ準備
  - package.json の最終調整
  - bin フィールドの設定
  - 基本的な README.md
  - _要件: 13.1_

- [ ] 7.3 基本ドキュメント
  - クイックスタートガイド（5分で動作確認）
  - 基本的な設定例
  - よくある問題のトラブルシューティング
  - _要件: 14.1, 14.4_

## Phase 2: 機能拡張と最適化

### 8. 高度な機能（優先度中）

- [ ] 8.1 MCP サーバー統合
  - 基本的な MCP クライアント実装
  - ツール実行機能
  - エラーハンドリング
  - _要件: 8.1, 8.2, 8.3_

- [ ] 8.2 ターミナル実行機能
  - terminal/exec メソッドの実装
  - 基本的なコマンド実行
  - 出力キャプチャ
  - _要件: 12.1_

- [ ] 8.3 Git 操作サポート
  - 基本的な git コマンド実行
  - コミット・プッシュ機能
  - エラー処理
  - _要件: 12.2_

### 9. パフォーマンス改善

- [ ] 9.1 メモリ使用量最適化
  - バッファサイズの調整
  - メモリリーク検出と修正
  - ガベージコレクション最適化
  - _要件: 10.3, 10.4_

- [ ] 9.2 レスポンス時間改善
  - 非同期処理の最適化
  - キャッシュ機能の実装
  - 起動時間の短縮
  - _要件: 10.1, 10.2_

### 10. Rust 移行準備

- [ ] 10.1 Rust プロジェクト基盤
  - Cargo.toml の作成
  - 基本的なモジュール構造
  - TypeScript 版との機能パリティ確認
  - _要件: 11.1_

- [ ] 10.2 Rust 版コア機能実装
  - ACP プロトコル実装
  - Droid CLI 統合
  - 基本的なファイル操作
  - _要件: 1.1, 2.1, 4.1_

- [ ] 10.3 Rust 版パフォーマンス最適化
  - 非同期 I/O（Tokio）
  - ゼロコピー最適化
  - メモリプール実装
  - _要件: 品質目標（起動時間 < 100ms）_

## 後続スプリント: 継続的改善

### 継続的な機能拡張と品質向上

- [ ] 継続1. 包括的テストの拡充
  - E2E テストシナリオの追加
  - パフォーマンステストの自動化
  - エラーケースの網羅的テスト
  - _要件: 品質目標_

- [ ] 継続2. ドキュメントの充実
  - API リファレンスの完成
  - アーキテクチャ文書の作成
  - コントリビューションガイドの整備
  - _要件: 14.2, 14.3_

- [ ] 継続3. 監視とメトリクス
  - パフォーマンス監視の実装
  - エラー率追跡
  - ユーザー行動分析
  - _要件: 品質目標_

- [ ] 継続4. コミュニティ構築
  - Issue テンプレートの整備
  - サンプルとデモの作成
  - ブログ記事とドキュメント
  - _要件: コミュニティ構築_

## 重要な原則

### 各スプリントでの価値提供
- **スプリント 1**: Zed エディタから接続できる（技術的実現可能性の証明）
- **スプリント 2**: Droid AI と実際に対話できる（基本的なユーザー価値）
- **スプリント 3**: リアルタイムで思考過程が見える（UX の大幅改善）
- **スプリント 4**: ファイル編集ができる（実用的な価値）
- **スプリント 5**: 安定して動作する（信頼性の確保）
- **スプリント 6**: 設定可能で使いやすい（ユーザビリティ）
- **スプリント 7**: 簡単にインストールできる（普及可能性）

### 実装アプローチ
1. **動作する最小限の実装**: 完璧を目指さず、まず動くものを作る
2. **段階的改善**: 各スプリントで前のスプリントの機能を改善
3. **ユーザーフィードバック重視**: 早期にユーザーに触ってもらい、フィードバックを得る
4. **技術的負債の管理**: 急いで作った部分は後で必ずリファクタリング